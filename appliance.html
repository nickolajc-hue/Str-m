<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Apparat-prisberegner</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  margin:10px;
  background-color:#111;
  color:#eee;
}
h1 { font-size:1.5em; }
label, input, select { display:block; margin-top:10px; }
#applianceChart { margin-top:20px; max-width:100%; }
</style>
</head>
<body>
<h1>⚡ Planlæg billigste tidspunkt for dit apparat</h1>

<label>Vælg apparat:</label>
<select id="appliance">
  <option value="1.5">Opvaskemaskine (1,5 kW)</option>
  <option value="2.0">Vaskemaskine (2 kW)</option>
  <option value="3.6">Elbil-ladning (3,6 kW)</option>
</select>

<label>Brugstid i timer:</label>
<input type="number" id="hours" value="1" min="0.1" step="0.1">

<label>Vælg starttidspunkt (0-23): <span id="startLabel">0</span>:00</label>
<input type="range" id="preferredStart" min="0" max="23" value="0" step="1" oninput="document.getElementById('startLabel').textContent = this.value; calculate()">

<div id="totalCost"></div>
<div id="preferredCost"></div>
<div id="bestTime"></div>

<canvas id="applianceChart" width="400" height="300"></canvas>

<script>
const elAfgift = 0.90;
const systemTarif = 0.092;
const transport = 0.076;
const moms = 1.25;

// Timebaseret nettarif
const nettTarifPerHour = [
  0.07,0.07,0.07,0.07,0.07,0.07, // 00-05
  0.20,0.20,0.20,0.20,0.20,0.20,0.20,0.20,0.20,0.20,0.20, // 06-16
  0.61,0.61,0.61,0.61, // 17-20
  0.20,0.20,0.20 // 21-23
];

let chartInstance = null;

function getTotalPrice(spot, hour, power){
  const nett = nettTarifPerHour[hour];
  return (spot + elAfgift + systemTarif + transport + nett) * moms * power;
}

async function calculate(){
  const power = parseFloat(document.getElementById("appliance").value);
  const duration = parseFloat(document.getElementById("hours").value);
  const preferred = parseInt(document.getElementById("preferredStart").value);

  // Hent spotpriser
  const url = `https://api.energidataservice.dk/dataset/Elspotprices?filter={"PriceArea":"DK1"}&sort=HourUTC ASC&limit=24`;
  const res = await fetch(url);
  const data = await res.json();

  const hoursLabels = data.records.map(r=>{
    const d = new Date(r.HourUTC);
    return d.getHours();
  });

  const spotPrices = data.records.map(r=>(r.SpotPriceEUR*7.45)/1000);
  const totalPrices = spotPrices.map((p,i)=>getTotalPrice(p,i,power));

  // Find billigste periode
  let minSum = Infinity, bestIndex = 0;
  for(let i=0;i<=totalPrices.length-duration;i++){
    const sum = totalPrices.slice(i,i+duration).reduce((a,b)=>a+b,0);
    if(sum < minSum){ minSum = sum; bestIndex = i; }
  }

  document.getElementById("totalCost").innerHTML = `Billigste totalpris: ${minSum.toFixed(2)} kr`;
  document.getElementById("bestTime").innerHTML = `Anbefalet starttidspunkt: ${hoursLabels[bestIndex]}:00 i ${duration} timer`;

  // Pris hvis valgt start
  let preferredSumText = '';
  if(preferred>=0 && preferred+duration<=24){
    const preferredSum = totalPrices.slice(preferred, preferred+duration).reduce((a,b)=>a+b,0);
    preferredSumText = `Pris hvis du starter kl ${hoursLabels[preferred]}:00 → ${preferredSum.toFixed(2)} kr`;
  }
  document.getElementById("preferredCost").innerHTML = preferredSumText;

  // Farvekodning
  const backgroundColors = totalPrices.map((p,i)=>{
    if(i>=bestIndex && i<bestIndex+duration) return '#4CAF50'; // billigste
    if(preferred>=0 && i>=preferred && i<preferred+duration) return '#2196F3'; // valgt
    if(p>0.5) return '#FF3B30'; // høj pris
    return '#FFA500'; // øvrige
  });

  const ctx = document.getElementById('applianceChart').getContext('2d');
  if(chartInstance) chartInstance.destroy();
  chartInstance = new Chart(ctx,{
    type:'bar',
    data:{
      labels: hoursLabels.map(h=>h+":00"),
      datasets:[{
        label:'Pris pr. time (kr)',
        data: totalPrices.map(p=>p.toFixed(2)),
        backgroundColor: backgroundColors
      }]
    },
    options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
  });
}

// Event listeners
document.getElementById("appliance").addEventListener("change", calculate);
document.getElementById("hours").addEventListener("change", calculate);
document.getElementById("preferredStart").addEventListener("input", calculate);

// Initial load + auto-opdatering hvert 5. minut
calculate();
setInterval(calculate, 300000); // 300000ms = 5min
</script>
</body>
</html>
