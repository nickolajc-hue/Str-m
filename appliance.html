<!DOCTYPE html>
<html lang="da">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Apparat-prisberegner interaktiv</title>
<link rel="stylesheet" href="styles.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
<style>
#applianceChart { cursor: pointer; }
</style>
</head>
<body>
<h1>⚡ Planlæg billigste tidspunkt for dit apparat</h1>

<label>Vælg apparat:</label>
<select id="appliance">
  <option value="1.5">Opvaskemaskine (1,5 kW)</option>
  <option value="2.0">Vaskemaskine (2 kW)</option>
  <option value="3.6">Elbil-ladning (3,6 kW)</option>
</select>

<label>Brugstid i timer:</label>
<input type="number" id="hours" value="1" min="0.1" step="0.1">

<div id="totalCost"></div>
<div id="preferredCost"></div>
<div id="bestTime"></div>
<canvas id="applianceChart" width="400" height="300" style="margin-top:30px;"></canvas>

<p><a href="index.html">← Tilbage til DK1-priser</a></p>

<script>
const netTarif = 0.55;
const elAfgift = 0.80;
const moms = 1.25;

function getTotalPrice(spot){ return (spot + netTarif + elAfgift) * moms; }

let costPerHour = [];
let hoursLabels = [];
let power = 1.5;
let duration = 1;
let chartInstance = null;
let bestIndex = 0;

async function fetchData(){
    const url = `https://api.energidataservice.dk/dataset/Elspotprices?filter={"PriceArea":"DK1"}&sort=HourUTC ASC&limit=24`;
    const res = await fetch(url);
    const data = await res.json();
    hoursLabels = data.records.map(r=>new Date(r.HourUTC).getHours());
    const spotPrices = data.records.map(r=>(r.SpotPriceEUR*7.45)/1000);
    costPerHour = spotPrices.map(p=>getTotalPrice(p)*power);
    findBestPeriod();
    drawChart();
}

function findBestPeriod(){
    duration = parseFloat(document.getElementById("hours").value);
    let minSum = Infinity;
    bestIndex = 0;
    for(let i=0; i<=costPerHour.length-duration; i++){
        const sum = costPerHour.slice(i,i+duration).reduce((a,b)=>a+b,0);
        if(sum < minSum){ minSum = sum; bestIndex = i; }
    }
    document.getElementById("totalCost").innerHTML = `Billigste totalpris: ${minSum.toFixed(2)} kr`;
    document.getElementById("bestTime").innerHTML = `Anbefalet starttidspunkt: ${hoursLabels[bestIndex]}:00 i ${duration} timer`;
}

function drawChart(preferredIndex = null){
    if(chartInstance) chartInstance.destroy();
    chartInstance = new Chart(document.getElementById('applianceChart').getContext('2d'),{
        type:'bar',
        data:{
            labels: hoursLabels.map(h=>h+":00"),
            datasets:[{
                label:'Pris pr. time (kr)',
                data: costPerHour.map(p=>p.toFixed(2)),
                backgroundColor: costPerHour.map((p,i)=>{
                    if(i>=bestIndex && i<bestIndex+duration) return '#4CAF50'; // billigste
                    if(preferredIndex!==null && i>=preferredIndex && i<preferredIndex+duration) return '#2196F3'; // valgt
                    return '#FFA500';
                })
            }]
        },
        options:{
            responsive:true,
            plugins:{legend:{display:false}},
            onClick: function(evt, elements){
                if(!elements.length) return;
                const index = elements[0].index;
                if(index+duration>24) return;
                const sum = costPerHour.slice(index,index+duration).reduce((a,b)=>a+b,0);
                document.getElementById("preferredCost").innerHTML = `Pris hvis du starter kl ${hoursLabels[index]}:00 → ${sum.toFixed(2)} kr`;
                drawChart(index);
            }
        }
    });
}

// Update power/duration dynamically
document.getElementById("appliance").addEventListener("change", e=>{
    power = parseFloat(e.target.value);
    fetchData();
});
document.getElementById("hours").addEventListener("change", e=>{
    duration = parseFloat(e.target.value);
    fetchData();
});

// Initial load
fetchData();
</script>
</body>
</html>
